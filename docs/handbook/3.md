## phpMailer任意i代码执行漏洞分析过程

* 1：查找漏洞点（`$params` , 会被攻击手控制了，所以可以写入任何文件） 

![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091946901.webp)

* 2：函数朔源，找到过滤点（去看函数的回溯看它调用了哪些参数或数据）

![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091947242.webp)

* 3.分析正则表达式(过滤点) 绕过方法
* 4.手工调试正则表达式

## 查缺补漏

![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091947789.webp)


![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091947773.webp)


![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091947475.webp)

![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091948917.webp)


# sql注入

* 反向查找
1.通过可控变量(也就是输入点)回溯危险函数
2.查找危险函数确定可控变量
3.传递的过程中触发漏洞

![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091948452.webp)


![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091948237.webp)


![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091948915.webp)



## 反向漏洞挖掘特点
* 根源：危险函数导致的漏洞
* 特点：
1.暴力:全局搜索危险函数
2.简单：无需过多理解目标网站功能与架构
3.快速：适用于自动化代码审计工具
4.命中率低：简单的漏洞越来越少
5.无法挖掘逻辑漏洞：逻辑漏洞多数不存在危险函数，或危险函数的参数
6.适用性较差：不适合存在全局过滤的站点




## 正向漏洞挖掘特点
* 正向查找流程

![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091949449.webp)



* 根源：程序员疏忽或逻辑问题导致漏洞
* 特点：
1.复杂：需要及其了解目标源码的功能与架构
2.跳跃性大：涉及M/V/C/Service/Dao等多个层面
3.漏洞的组合：通常是多个漏洞的组合，很可能存在逻辑相关的漏洞
4.潜力无限：安全研究人员的宝库


## 双向漏洞挖掘特点
* 根源：理解程序执行过程，寻找危险逻辑
* 特点：
1.高校：如挖掘隧道，双向开工，时间减半
2.知识面广：需要同时掌握正向，反向挖掘技巧，并进行结合，以及所有正向，反向的优点



![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091949912.webp)

![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091949632.webp)

# 技巧

![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091949750.webp)

* (intval) 这个函数是将用户输入的内容转换成数字类型的变量

![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091950753.webp)


* 这是转换后的数据

![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091950380.webp)


* (addslashes) 这个函数是将用户的输入进行一个转义。也会存在宽字符注入

![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091950939.webp)


![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091951022.webp)


![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091951281.webp)



* 这是转义后的数据

![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091951613.webp)


![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091951795.webp)




漏洞例子：

* 直接获取到get的变量里的name参数


![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091952419.webp)


* (htmlspecialchars) 函数

![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091952905.webp)


![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091952511.webp)


* 用户输入你即使用了 addslashes() 这个函数，对用户进行了转义,但是在拼接语句的时候没有使用(' 单引号) 它任然无法访问sql漏洞的

![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091953959.webp)


* (str_replace) 函数

![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091953368.webp)


![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091953939.webp)


* (is_numeric) 函数

![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091953576.webp)

* (header) 函数会给用户返回一个页面，并没有阻止这个php继续运行，虽然判断了这个是不是数字，虽然进行了404页面这个返回，但是并没有停止这个页面的执行，也就导致后面这个sql语句仍然被执行

![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091954504.webp)

  



## 任意文件操作


![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091954825.webp)


![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091954752.webp)



## PHP命令执行

![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091954431.webp)


* 如何防御PHP的命令注入漏洞：可能需要设置白名单，去过滤掉用户输入的注入字符
1：首先黑白名单究竟在限制什么， 


![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091954468.webp)


![Img](https://rtyu-1317440738.cos.ap-guangzhou.myqcloud.com/202305091955680.webp)

